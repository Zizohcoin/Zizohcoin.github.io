import React, { useEffect, useMemo, useState } from "react";
import {
  ConnectionProvider,
  WalletProvider,
  useWallet
} from "@solana/wallet-adapter-react";
import {
  WalletModalProvider,
  WalletMultiButton
} from "@solana/wallet-adapter-react-ui";
import {
  PhantomWalletAdapter,
  SolflareWalletAdapter,
  TorusWalletAdapter
} from "@solana/wallet-adapter-wallets";
import { clusterApiUrl, Connection, PublicKey } from "@solana/web3.js";

const TOKEN_MINT = "22qVsVm2dyFg5WC72hQTdh92GgFqwboAQ7TMAHhfpump";

const WalletAccess = () => {
  const { publicKey, connected } = useWallet();
  const [hasToken, setHasToken] = useState(false);
  const [loading, setLoading] = useState(false);

  const verificarToken = async () => {
    if (!publicKey) return;
    setLoading(true);

    try {
      const connection = new Connection(
        "https://rpc.helius.xyz/?api-key=6a3b2ee3-2359-4ef2-8eb7-91a6c73d3b36",
        "confirmed"
      );
      const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
        publicKey,
        {
          programId: new PublicKey(
            "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"
          )
        }
      );

      const possui = tokenAccounts.value.some((account) => {
        const info = account.account.data.parsed.info;
        return (
          info.mint === TOKEN_MINT &&
          parseFloat(info.tokenAmount.uiAmount) > 0
        );
      });

      setHasToken(possui);
    } catch (error) {
      console.error("Erro ao verificar token:", error);
      setHasToken(false);
    }

    setLoading(false);
  };

  useEffect(() => {
    if (connected) {
      verificarToken();
    }
  }, [connected, publicKey]);

  if (!connected) {
    return <p>Conecte sua carteira para continuar.</p>;
  }

  return (
    <div>
      <p>Carteira: {publicKey.toBase58()}</p>
      {loading ? (
        <p>🔄 Verificando tokens...</p>
      ) : hasToken ? (
        <div>
          <p>✅ Acesso liberado! Você possui o token ZOH.</p>
          <div className="research-content">[Conteúdo da pesquisa aqui]</div>
        </div>
      ) : (
        <p>❌ Você não possui o token necessário para acessar esta área.</p>
      )}
    </div>
  );
};

const ResearchPage = () => {
  const endpoint = clusterApiUrl("mainnet-beta");
  const wallets = useMemo(
    () => [
      new PhantomWalletAdapter(),
      new SolflareWalletAdapter(),
      new TorusWalletAdapter()
    ],
    []
  );

  return (
    <ConnectionProvider endpoint={endpoint}>
      <WalletProvider wallets={wallets} autoConnect>
        <WalletModalProvider>
          <div className="container" style={{ padding: 20 }}>
            <h1>🔐 Acesso à Área de Pesquisa</h1>
            <WalletMultiButton />
            <WalletAccess />
          </div>
        </WalletModalProvider>
      </WalletProvider>
    </ConnectionProvider>
  );
};

export default ResearchPage;
